name: Android APK Build

on:
  # Manual trigger from GitHub UI or API
  workflow_dispatch:
    inputs:
      upload_to_release:
        description: 'Upload to GitHub Release'
        required: true
        default: 'true'
        type: boolean

  # Or trigger on version tags
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version tags

      - name: Bump version code
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        id: bump
        run: |
          CURRENT=$(cat versioncode.txt | tr -d '[:space:]')
          NEXT=$((CURRENT + 1))
          echo "$NEXT" > versioncode.txt
          sed -i "s/android:versionCode=\"[0-9]*\"/android:versionCode=\"$NEXT\"/" android/AndroidManifest.xml
          echo "build_code=$NEXT" >> $GITHUB_OUTPUT
          echo "Version code bumped: $CURRENT -> $NEXT"

      - name: Get version info
        id: version
        run: |
          VERSION=$(grep 'project.*VERSION' CMakeLists.txt | sed 's/.*VERSION \([0-9]*\.[0-9]*\.[0-9]*\).*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Qt for Android
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.10.2'
          target: 'android'
          arch: 'android_arm64_v8a'
          modules: 'qtquick3d qtshadertools qtcharts qtconnectivity qtmultimedia qtpositioning qtspeech qtwebsockets'
          cache: true
          cache-key-prefix: 'qt-android-v1'

      - name: Install Android NDK
        run: |
          # Try to detect which NDK version Qt expects
          QT_NDK_VERSION=""
          for TOOLCHAIN in "$QT_ROOT_DIR/lib/cmake/Qt6/qt.toolchain.cmake" \
                           "$QT_ROOT_DIR/lib/cmake/Qt6/android.toolchain.cmake"; do
            if [ -f "$TOOLCHAIN" ] && [ -z "$QT_NDK_VERSION" ]; then
              QT_NDK_VERSION=$(grep -oP 'ANDROID_NDK_REVISION\s+"?\K[0-9.]+' "$TOOLCHAIN" 2>/dev/null || true)
            fi
          done

          # Fallback to known-good version for Qt 6.10.x
          if [ -z "$QT_NDK_VERSION" ]; then
            QT_NDK_VERSION="27.1.12297006"
          fi

          echo "NDK version needed: $QT_NDK_VERSION"

          # Install if not already present
          if [ ! -d "$ANDROID_SDK_ROOT/ndk/$QT_NDK_VERSION" ]; then
            echo "Installing NDK $QT_NDK_VERSION..."
            yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" "ndk;$QT_NDK_VERSION" || true
          else
            echo "NDK $QT_NDK_VERSION already installed"
          fi

          echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/$QT_NDK_VERSION" >> $GITHUB_ENV

      - name: Decode Android keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > $RUNNER_TEMP/keystore.jks
          echo "ANDROID_KEYSTORE_PATH=$RUNNER_TEMP/keystore.jks" >> $GITHUB_ENV

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          $QT_ROOT_DIR/bin/qt-cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5

      - name: Build
        env:
          QT_ANDROID_KEYSTORE_STORE_PASS: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEYSTORE_PATH: ${{ env.ANDROID_KEYSTORE_PATH }}
        run: |
          cd build
          cmake --build . --config Release --parallel $(nproc)

      - name: Find APK
        id: apk
        run: |
          VERSION=${{ steps.version.outputs.version }}

          echo "=== All APK files ==="
          find build -name "*.apk" -type f 2>/dev/null || true

          echo "=== All AAB files ==="
          find build -name "*.aab" -type f 2>/dev/null || true

          # Look for versioned APK first (from build.gradle hook)
          APK_PATH=$(find build -name "Decenza_DE1_${VERSION}.apk" -type f 2>/dev/null | head -1)

          # Fallback: signed APK
          if [ -z "$APK_PATH" ]; then
            APK_PATH=$(find build -name "*-release-signed.apk" -type f 2>/dev/null | head -1)
          fi

          # Last resort: unsigned APK
          if [ -z "$APK_PATH" ]; then
            APK_PATH=$(find build -name "*-release-unsigned.apk" -type f 2>/dev/null | head -1)
          fi

          echo "Found APK: $APK_PATH"
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT

      - name: Sign APK if unsigned
        id: signed_apk
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        run: |
          APK="${{ steps.apk.outputs.apk_path }}"
          VERSION=${{ steps.version.outputs.version }}

          if [ -z "$APK" ]; then
            echo "ERROR: No APK found!"
            exit 1
          fi

          if echo "$APK" | grep -q "unsigned"; then
            echo "APK is unsigned, signing manually..."
            APKSIGNER=$(find $ANDROID_SDK_ROOT/build-tools -name "apksigner" -not -name "*.bat" -type f | sort -V | tail -1)

            if [ -n "$APKSIGNER" ]; then
              SIGNED_APK="$(dirname $APK)/Decenza_DE1_${VERSION}.apk"
              $APKSIGNER sign \
                --ks "$ANDROID_KEYSTORE_PATH" \
                --ks-key-alias "de1-key" \
                --ks-pass "pass:$ANDROID_KEYSTORE_PASSWORD" \
                --out "$SIGNED_APK" \
                "$APK"
              echo "Signed APK: $SIGNED_APK"
              echo "apk_path=$SIGNED_APK" >> $GITHUB_OUTPUT
            else
              echo "ERROR: apksigner not found!"
              exit 1
            fi
          else
            echo "APK is already signed"
            echo "apk_path=$APK" >> $GITHUB_OUTPUT
          fi

      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: Decenza_DE1-Android-arm64
          path: ${{ steps.signed_apk.outputs.apk_path || steps.apk.outputs.apk_path }}
          retention-days: 3

      - name: Upload to GitHub Release
        if: ${{ inputs.upload_to_release == true || startsWith(github.ref, 'refs/tags/v') }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          APK="${{ steps.signed_apk.outputs.apk_path }}"
          if [ -z "$APK" ]; then
            APK="${{ steps.apk.outputs.apk_path }}"
          fi

          # Find the release tag
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            TAG="v${VERSION}"
          fi

          echo "Uploading to release: $TAG"

          # Check if release exists, create if not
          if ! gh release view "$TAG" > /dev/null 2>&1; then
            echo "Creating release $TAG"
            gh release create "$TAG" \
              --title "Decenza $TAG" \
              --generate-notes
          fi

          # Upload APK
          if [ -n "$APK" ] && [ -f "$APK" ]; then
            gh release upload "$TAG" "$APK" --clobber
          fi

      - name: Inject build number into release notes
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          BUILD_CODE="${{ steps.bump.outputs.build_code }}"

          # Get current release notes
          CURRENT_NOTES=$(gh release view "$TAG" --json body --jq '.body' 2>/dev/null || echo "")

          # Only inject if Build: line is not already present
          if ! echo "$CURRENT_NOTES" | grep -qE "^Build:? [0-9]+"; then
            if [ -z "$CURRENT_NOTES" ]; then
              NEW_NOTES="Build: $BUILD_CODE"
            else
              # Insert Build: line after first heading or at the top
              NEW_NOTES=$(echo "$CURRENT_NOTES" | sed "0,/^## /{s/^## \(.*\)/## \1\n\nBuild: $BUILD_CODE/}")
              # If no heading was found (sed didn't change anything), prepend
              if [ "$NEW_NOTES" = "$CURRENT_NOTES" ]; then
                NEW_NOTES="Build: $BUILD_CODE

          $CURRENT_NOTES"
              fi
            fi
            gh release edit "$TAG" --notes "$NEW_NOTES"
            echo "Injected Build: $BUILD_CODE into release notes"
          else
            echo "Build number already present in release notes"
          fi

      - name: Commit version code back to main
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        run: |
          BUILD_CODE="${{ steps.bump.outputs.build_code }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git checkout origin/main
          echo "$BUILD_CODE" > versioncode.txt
          sed -i "s/android:versionCode=\"[0-9]*\"/android:versionCode=\"$BUILD_CODE\"/" android/AndroidManifest.xml
          git add versioncode.txt android/AndroidManifest.xml
          # Only commit if there are changes
          if git diff --cached --quiet; then
            echo "No version code changes to commit"
          else
            git commit -m "ci: bump version code to $BUILD_CODE [skip ci]"
            # Retry push with rebase in case main advanced during the build
            PUSH_OK=false
            for attempt in 1 2 3; do
              if git push origin HEAD:main; then
                echo "Committed version code $BUILD_CODE back to main"
                PUSH_OK=true
                break
              else
                echo "Push failed (attempt $attempt/3), rebasing..."
                git pull --rebase origin main
              fi
            done
            if [ "$PUSH_OK" != "true" ]; then
              echo "::warning::Could not push version code $BUILD_CODE back to main after 3 attempts"
            fi
          fi

      - name: Cleanup keystore
        if: always()
        run: |
          rm -f $RUNNER_TEMP/keystore.jks || true
