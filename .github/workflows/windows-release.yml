name: Windows Build

on:
  # Manual trigger from GitHub UI or API
  workflow_dispatch:
    inputs:
      upload_to_release:
        description: 'Upload to latest GitHub release'
        required: true
        default: 'false'
        type: boolean

  # Or trigger on version tags
  push:
    tags:
      - 'v*'

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for version tags

      - name: Bump version code
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        id: bump
        shell: bash
        run: |
          CURRENT=$(cat versioncode.txt | tr -d '[:space:]')
          NEXT=$((CURRENT + 1))
          echo "$NEXT" > versioncode.txt
          echo "build_code=$NEXT" >> $GITHUB_OUTPUT
          echo "Version code bumped: $CURRENT -> $NEXT"

      - name: Get version info
        id: version
        shell: bash
        run: |
          VERSION=$(grep 'project.*VERSION' CMakeLists.txt | sed 's/.*VERSION \([0-9]*\.[0-9]*\.[0-9]*\).*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.10.2'
          target: 'desktop'
          arch: 'win64_msvc2022_64'
          modules: 'qtquick3d qtshadertools qtcharts qtconnectivity qtmultimedia qtpositioning qtspeech qtwebsockets qtserialport'
          cache: true
          cache-key-prefix: 'qt-windows-v2'

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install OpenSSL
        id: openssl
        shell: powershell
        run: |
          choco install openssl -y --no-progress

          # Find libssl-3-x64.dll - Chocolatey may install to different paths
          $candidates = @(
            "C:\Program Files\OpenSSL-Win64\bin",
            "C:\Program Files\OpenSSL\bin",
            "C:\OpenSSL-Win64\bin"
          )

          $opensslBin = $null
          foreach ($dir in $candidates) {
            if (Test-Path "$dir\libssl-3-x64.dll") {
              $opensslBin = $dir
              break
            }
          }

          # Fallback: search Program Files for the DLL
          if (-not $opensslBin) {
            $found = Get-ChildItem "C:\Program Files" -Recurse -Filter "libssl-3-x64.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($found) {
              $opensslBin = $found.DirectoryName
            }
          }

          if ($opensslBin) {
            Write-Host "OpenSSL 3 found at: $opensslBin"
            echo "dir=$opensslBin" >> $env:GITHUB_OUTPUT
          } else {
            Write-Error "libssl-3-x64.dll not found in any known location"
            exit 1
          }

      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_PREFIX_PATH="$env:QT_ROOT_DIR"

      - name: Build Release
        run: |
          cd build
          cmake --build . --config Release --parallel

      - name: Download VC++ Redistributable
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path vcredist
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "vcredist\vc_redist.x64.exe"

      - name: Install Inno Setup
        shell: powershell
        run: |
          choco install innosetup -y

      - name: Create Inno Setup config
        shell: powershell
        run: |
          $VERSION = "${{ steps.version.outputs.version }}"
          $BUILD_NUM = (Get-Content "versioncode.txt").Trim()
          $WORKSPACE = $env:GITHUB_WORKSPACE
          $QT_DIR = $env:QT_ROOT_DIR

          # Create version.iss
          @"
          #define BuildNumber "$BUILD_NUM"
          #define VersionNumber "$VERSION"
          #define TargetName "Decenza_DE1"
          #define TargetArch "x64"
          #define TargetProduct "Decenza"
          #define TargetCompany "Decenza"
          "@ | Out-File -FilePath "installer\version.iss" -Encoding ASCII

          # Create setupvars.iss for CI
          @"
          ; CI-generated paths
          #define SourceDir "$WORKSPACE"
          #define AppBuildDir "$WORKSPACE\build\Release"
          #define AppDeployDir "$WORKSPACE\installer\deploy"
          #define QtDir "$QT_DIR"
          #define VcRedistDir "$WORKSPACE\vcredist"
          #define VcRedistFile "vc_redist.x64.exe"
          #define OpenSslDir "${{ steps.openssl.outputs.dir }}"
          "@ | Out-File -FilePath "installer\setupvars.iss" -Encoding ASCII

          Write-Host "=== version.iss ==="
          Get-Content installer\version.iss
          Write-Host "=== setupvars.iss ==="
          Get-Content installer\setupvars.iss

      - name: Build Installer
        shell: cmd
        run: |
          "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /O"installer\Output" installer\setup.iss

      - name: List output
        shell: bash
        run: |
          echo "=== Installer output ==="
          ls -la installer/Output/

      - name: Upload artifact
        uses: actions/upload-artifact@v7
        with:
          name: Decenza_DE1-Windows-Installer
          path: installer/Output/*.exe
          retention-days: 1
          overwrite: true

      - name: Upload to GitHub Release
        if: ${{ inputs.upload_to_release == true || startsWith(github.ref, 'refs/tags/v') }}
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          INSTALLER="installer/Output/Decenza_DE1_v${VERSION}_winx64_installer.exe"

          # Find the release (by tag or latest)
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            TAG="v${VERSION}"
          fi

          echo "Uploading to release: $TAG"
          gh release upload "$TAG" "$INSTALLER" --clobber || echo "Release $TAG not found, skipping upload"
